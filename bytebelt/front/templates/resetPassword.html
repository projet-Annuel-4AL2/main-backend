{% extends 'base.html' %}

{% block title %}
Reset Password
{% endblock %}

{% block content %}
<section class="py-3 py-md-5 py-xl-8">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="mb-5">
                    <h2 class="display-5 fw-bold text-center text-[#CBCBCB]">Reset Password</h2>
                    <p class="text-center m-0 text-[#CBCBCB]">Remembered your password? <a href="{% url 'login' %}" class="hover:text-[#808080]">Log in</a></p>
                </div>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10 col-xl-8">
                <div class="row gy-5 justify-content-center">
                    <div class="col-12 col-lg-5">
                        <form id="email-form" method="post">
                            {% csrf_token %}
                            <div class="row gy-3 overflow-hidden">
                                <div class="col-12">
                                    <div class="form-floating mb-3">
                                        <input type="email" class="form-control border-0 border-bottom rounded-3" id="email" name="email" placeholder="Email" required>
                                        <label for="email" class="form-label">Email</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-grid">
                                        <button class="btn btn-lg btn-dark rounded-3 fs-6" type="submit">Reset Password</button>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <form id="password-form" method="post" style="display: none;">
                            {% csrf_token %}
                            <div class="row gy-3 overflow-hidden">
                                <div class="col-12">
                                    <div class="form-floating mb-3">
                                        <input type="password" class="form-control border-0 border-bottom rounded-3" id="password" name="password" placeholder="New Password" required>
                                        <label for="password" class="form-label">New Password</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating mb-3">
                                        <input type="password" class="form-control border-0 border-bottom rounded-3" id="password2" name="password2" placeholder="Confirm Password" required>
                                        <label for="password2" class="form-label">Confirm Password</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-grid">
                                        <button class="btn btn-lg btn-dark rounded-3 fs-6" type="submit">Submit New Password</button>
                                    </div>
                                </div>
                            </div>
                        </form>

                        {% if error %}
                            <div class="alert alert-danger" role="alert" id="error-message">
                                {{ error }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    function checkPassword(){
        var password = document.getElementById('password').value;
        if (password.length < 8) {
            document.getElementById('error-message').innerText = 'Password must be at least 8 characters';
            return false;
        }
        return true;
    }

    document.getElementById('email-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var email = document.querySelector('#email').value;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/resetpassword/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var response = JSON.parse(xhr.responseText);
                if (xhr.status === 200) {
                    document.getElementById('email-form').style.display = 'none';
                    document.getElementById('password-form').style.display = 'block';
                } else {
                    document.getElementById('error-message').innerText = response.error || 'An error occurred';
                    setTimeout(function() {
                        document.getElementById('error-message').innerText = '';
                    }, 2000);
                }
            }
        };
        
        xhr.send(JSON.stringify({email: email}));
    });

    document.getElementById('password-form').addEventListener('submit', function(e) {
        e.preventDefault();

        var password = document.querySelector('#password').value;
        var password2 = document.querySelector('#password2').value;
        
        if (password !== password2) {
            document.getElementById('error-message').innerText = 'Passwords do not match';
            setTimeout(function() {
                document.getElementById('error-message').innerText = '';
            }, 2000);
            return;
        }

        if (!checkPassword()) {
            setTimeout(function() {
                document.getElementById('error-message').innerText = '';
            }, 2000);
            return;
        }

        var email = document.querySelector('#email').value; // Assuming email is still accessible
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/ChangePassword/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                var response = JSON.parse(xhr.responseText);
                if (xhr.status === 200) {
                    window.location.href = '/login/';
                } else {
                    document.getElementById('error-message').innerText = response.error || 'An error occurred';
                    setTimeout(function() {
                        document.getElementById('error-message').innerText = '';
                    }, 2000);
                }
            }
        };
        
        xhr.send(JSON.stringify({email: email, password: password}));
    });
</script>
{% endblock %}